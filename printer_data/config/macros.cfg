#####################################################################
# Macros
#####################################################################

[gcode_arcs]
resolution: 0.1

[gcode_macro START_PRINT_OLD]
gcode:
	{% set BED_TEMP=params.BED_TEMP|default(60)|float %}
	{% set EXTRUDER_TEMP=params.EXTRUDER_TEMP|default(170)|float %}
	
	# Home the printer
	G90
	M83
	G28
	
	# Preheat the bed
	M140 S{BED_TEMP}
	M190 S{BED_TEMP}
	M104 S170
	
	# Z probing sequence
	#BED_MESH_CALIBRATE PROFILE=adaptive ADAPTIVE=1
	BED_MESH_PROFILE LOAD=100deg
	
	# Heat the extruder to the desired temperature
	M104 S{EXTRUDER_TEMP}
	M109 S{EXTRUDER_TEMP}
	
	# Prime line sequence
	G1 Z5 F3000 ; lift
	G1 X20 Y5 F1500 ; move to prime position
	G1 Z0.15 F3000 ; get ready to prime
	G92 E0 ; reset extrusion distance
	G1 X50 E30 F600 ; prime nozzle with adjusted extrusion / E__ based on how much you like
	
	# String removal circle after priming
	#G1 Z0.2 F3000 ; adjust to 0.2mm above the bed
	#G1 Y15 F10000 ; move the toolhead in the Y direction by 15 units
	
	# Execute the circle 3 times
	#G2 I-5 J0 F10000 ; circle with 5mm radius
	#G2 I-5 J0 F10000
	#G2 I-5 J0 F10000

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(230)|float %} # Mudei para coincidir com o fatiador comum
    {% set PREHEAT_TEMP = 150 %} # Temperatura para evitar vazamento (oozing)

    # 1. Iniciar aquecimento inicial
    M117 Aquecendo...
    M140 S{BED_TEMP}             ; Começa a aquecer a mesa
    M104 S{PREHEAT_TEMP}        ; Pré-aquece o bico sem derreter o filamento
    G90                          ; Coordenadas absolutas
    M83                          ; Extrusora em modo relativo
    
    # 2. Home e Nivelamento
    G28                          ; Home em todos os eixos
    M190 S{BED_TEMP}             ; Espera a mesa atingir a temperatura real

    M117 Carregando Mesh...
    BED_MESH_PROFILE LOAD=100deg
    #M117 Calibrando Mesh...
    #BED_MESH_CALIBRATE ADAPTIVE=1 ; O Adaptive Mesh economiza muito tempo
    
    # 3. Posicionamento e Aquecimento Final
    G1 X5 Y5 Z10 F5000           ; Move para o canto para terminar de aquecer
    M109 S{EXTRUDER_TEMP}        ; Espera o bico atingir a temperatura de impressão
    
    # 4. Sequência de Purga (Prime Line) mais eficiente
    M117 Purgando...
    G1 Z0.28 F3000               ; Altura da primeira camada da purga
    G92 E0                       ; Reset extrusora
    G1 X60 E15 F1000             ; Primeira linha de purga
    G1 Y5.4 F5000                ; Pequeno desvio lateral
    G1 X10 E15 F1000             ; Segunda linha retornando
    G92 E0                       ; Reset extrusora final
    G1 Z2.0 F3000                ; Levanta levemente para começar a peça
    M117 Imprimindo...
    
   
[gcode_macro END_PRINT]
#   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-4.0 F3600                 ; retract filament
    G91                            ; relative positioning

    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    #   Check end position to determine safe direction to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    G0 Z{z_safe} F3600             ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    G0 X60 Y{max_y-10} F3600          ; park nozzle at rear
    M84
  
[gcode_macro LOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E30 F300                    ; load
   G1 E15 F150                    ; prime nozzle with filament
   M82                            ; set extruder to absolute
    
[gcode_macro UNLOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E10 F300                    ; extrude a little to soften tip
   G1 E-120 F1200                  ; retract some, but not too much or it will jam
   M82                            ; set extruder to absolute


[resonance_tester]
probe_points: 75, 75, 20
accel_chip: adxl345

######################### MISC #########################

# Replace M109 (Wait for Hotend Temperature) with TEMPERATURE_WAIT so we don't have to wait for PID to level off.
[gcode_macro M109]
rename_existing: M99109
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+2}   ; Wait for hotend temp (within 4 degree)
    {% endif %}

[gcode_macro M190]
rename_existing: M99190
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   ; Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+2}  ; Wait for bed temp (within 3 degree)
    {% endif %}